<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="HealthBite - Complete Your Hybrid Health Profile">
    <title>HealthBite | Health Profile Setup</title>
    <!-- Icons and Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="chatbot.css">
    <script src="chatbot.js" defer></script>
    <style>
        :root {
            --brand-primary: #10b981;
            /* Green theme as per Image 1 */
            --brand-primary-dark: #059669;
            --brand-primary-light: #d1fae5;
            --brand-blue: #3b82f6;
            --brand-blue-light: #dbeafe;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --bg-page: #f8fafc;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-page);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            overflow-x: hidden;
        }

        /* --- SIDEBAR (Consistent with user.html) --- */
        aside.sidebar {
            width: 280px;
            height: 100vh;
            background: #ffffff;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 40px 20px;
            position: sticky;
            top: 0;
            flex-shrink: 0;
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 40px;
            padding: 0 10px;
        }

        .logo-box {
            width: 40px;
            height: 40px;
            background: var(--brand-primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .sidebar-brand h1 {
            font-size: 22px;
            font-weight: 800;
            letter-spacing: -0.8px;
        }

        .sidebar-brand span {
            color: var(--brand-primary);
        }

        .nav-menu {
            display: flex;
            flex-grow: 1;
            flex-direction: column;
            gap: 4px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 15px;
            font-weight: 600;
            border-radius: 16px;
            transition: var(--transition);
        }

        .nav-link.active {
            background: #f0fdf4;
            color: var(--brand-primary);
        }

        .nav-link i {
            width: 24px;
            text-align: center;
        }

        /* --- MAIN CONTENT --- */
        main.main-content {
            flex-grow: 1;
            padding: 50px 80px;
            max-width: 1200px;
        }

        .page-header {
            margin-bottom: 40px;
        }

        .page-header h2 {
            font-size: 32px;
            font-weight: 800;
        }

        .step-label {
            font-size: 11px;
            font-weight: 800;
            color: var(--brand-primary);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 8px;
            display: block;
        }

        /* --- PROGRESS BAR --- */
        .progress-container {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 100px;
            margin: 24px 0 48px;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--brand-primary);
            width: 50%;
            /* Toggles to 100% */
            border-radius: 100px;
            transition: width 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .progress-info {
            display: flex;
            justify-content: flex-end;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-muted);
            margin-top: 8px;
        }

        /* --- STEPS LAYOUT --- */
        .step-view {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .step-view.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .grid-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
        }

        /* --- CARDS --- */
        .setup-card {
            background: white;
            border-radius: 32px;
            padding: 32px;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.02);
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 800;
            margin-bottom: 32px;
            color: #1e293b;
        }

        .card-title .icon-box {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--brand-primary-light);
            color: var(--brand-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        /* --- INPUT BOXES --- */
        .input-group {
            margin-bottom: 24px;
        }

        .input-group label {
            display: block;
            font-size: 11px;
            font-weight: 800;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 10px;
        }

        .input-field {
            width: 100%;
            padding: 16px 20px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 18px;
            font-family: inherit;
            font-size: 16px;
            font-weight: 700;
            transition: var(--transition);
            outline: none;
        }

        .input-field:focus {
            border-color: var(--brand-primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
        }

        /* --- BMI GAUGE --- */
        .bmi-gauge-box {
            margin-top: 32px;
            padding: 24px;
            background: #f8fafc;
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .bmi-val {
            font-size: 32px;
            font-weight: 800;
        }

        .bmi-unit {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 700;
            margin-left: 4px;
        }

        .bmi-status-pill {
            padding: 6px 16px;
            border-radius: 100px;
            font-size: 11px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .bmi-status-pill.normal {
            background: #dcfce7;
            color: #166534;
        }

        .bmi-status-pill.underweight {
            background: #dbeafe;
            color: #1e40af;
        }

        .bmi-status-pill.overweight {
            background: #fef9c3;
            color: #854d0e;
        }

        .bmi-status-pill.obese {
            background: #fee2e2;
            color: #991b1b;
        }

        /* --- DIETARY OPTION CARDS --- */
        .option-stack {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .option-card {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px 24px;
            background: white;
            border: 1.5px solid #e2e8f0;
            border-radius: 20px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .option-card:hover {
            border-color: var(--brand-primary);
        }

        .option-card.active {
            border-color: var(--brand-primary);
            background: #f0fdf4;
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.1);
        }

        .option-icon-box {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            background: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: var(--transition);
        }

        .option-card.active .option-icon-box {
            background: var(--brand-primary);
            color: white;
        }

        .option-card h4 {
            font-size: 16px;
            font-weight: 800;
        }

        .option-card p {
            font-size: 13px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .check-mark {
            margin-left: auto;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: var(--transition);
        }

        .option-card.active .check-mark {
            background: var(--brand-primary);
            border-color: var(--brand-primary);
            color: white;
        }

        /* --- PRE-SCAN BANNER --- */
        .prescan-banner {
            grid-column: 1 / -1;
            background: #0f172a;
            border-radius: 28px;
            padding: 32px;
            color: white;
            display: flex;
            gap: 48px;
            align-items: center;
        }

        .prescan-item {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            flex: 1;
        }

        .prescan-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-top: 6px;
        }

        .dot-green {
            background: #10b981;
            box-shadow: 0 0 10px #10b981;
        }

        .dot-yellow {
            background: #fbbf24;
            box-shadow: 0 0 10px #fbbf24;
        }

        .dot-red {
            background: #f87171;
            box-shadow: 0 0 10px #f87171;
        }

        .prescan-item h5 {
            font-size: 14px;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .prescan-item p {
            font-size: 12px;
            opacity: 0.6;
            line-height: 1.5;
        }

        /* --- STEP 2 CARDS --- */
        .condition-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .cond-card {
            border: 1.5px solid #e2e8f0;
            border-radius: 24px;
            overflow: hidden;
            transition: var(--transition);
        }

        .cond-card.active {
            border-color: var(--brand-primary);
        }

        .cond-header {
            padding: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            background: white;
        }

        .cond-expanded {
            display: none;
            padding: 0 24px 24px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
        }

        .cond-card.active .cond-expanded {
            display: block;
        }

        .exp-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 16px;
        }

        /* --- ACTIONS --- */
        .action-bar {
            margin-top: 48px;
            display: flex;
            justify-content: flex-end;
            gap: 16px;
        }

        .btn {
            padding: 16px 40px;
            border-radius: 18px;
            font-family: inherit;
            font-size: 16px;
            font-weight: 800;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-outline {
            background: white;
            border: 1.5px solid #e2e8f0;
            color: var(--text-muted);
        }

        .btn-primary {
            background: var(--brand-primary);
            color: white;
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.2);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(16, 185, 129, 0.3);
        }

        /* --- ALLERGY GRID --- */
        .allergy-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .allergy-item {
            padding: 20px;
            border-radius: 20px;
            border: 1.5px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .allergy-item.active {
            background: #fff1f2;
            border-color: #f87171;
            color: #991b1b;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 16px 24px;
            border-radius: 20px;
            background: #1e293b;
            color: white;
            font-weight: 800;
            transform: translateX(120%);
            transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .toast.active {
            transform: translateX(0);
        }

        .toast-success {
            background: var(--brand-primary);
        }

        .toast-error {
            background: #ef4444;
        }

        /* --- SUMMARY PAGE (Step 3) --- */
        .summary-card {
            background: white;
            border-radius: 32px;
            padding: 32px;
            border: 1px solid var(--border-color);
            margin-bottom: 24px;
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .summary-section-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 16px;
            font-weight: 800;
            color: #1e293b;
        }

        .edit-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: var(--transition);
        }

        .edit-btn:hover {
            color: var(--brand-primary);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 24px;
        }

        .summary-item label {
            display: block;
            font-size: 10px;
            font-weight: 800;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .summary-item span {
            font-size: 18px;
            font-weight: 800;
            color: var(--text-main);
        }

        .summary-item .unit {
            font-size: 13px;
            color: var(--text-muted);
            margin-left: 4px;
        }

        .bmi-mini-gauge {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #f1f5f9;
            display: flex;
            align-items: center;
            gap: 32px;
        }

        .bmi-bar-bg {
            flex-grow: 1;
            height: 6px;
            background: #f1f5f9;
            border-radius: 100px;
            position: relative;
            background: linear-gradient(to right, #3b82f6, #10b981, #fbbf24, #ef4444);
        }

        .bmi-marker {
            position: absolute;
            top: -4px;
            bottom: -4px;
            width: 4px;
            background: #1e293b;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            transition: left 1s ease;
        }

        .dietary-summary-card {
            background: #f0fdf4;
            border-radius: 20px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            border: 1px solid #dcfce7;
        }

        .clinical-stack {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .clinical-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: #f8fafc;
            border-radius: 16px;
        }

        .clinical-info h5 {
            font-size: 14px;
            font-weight: 800;
            margin-bottom: 2px;
        }

        .clinical-info p {
            font-size: 16px;
            font-weight: 800;
            color: #f59e0b;
        }

        .status-pill {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
        }

        .status-pill.moderate {
            background: #fef3c7;
            color: #92400e;
        }

        .status-pill.severe {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-pill.mild {
            background: #f1f5f9;
            color: #475569;
        }

        .safety-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .safety-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: white;
            border: 1px solid #f1f5f9;
            border-radius: 12px;
        }

        .severity-label {
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .severity-fatal {
            color: #f87171;
        }

        .severity-severe {
            color: #fb923c;
        }

        .severity-mild {
            color: #94a3b8;
        }

        .finalize-btn {
            background: #10b981;
            color: white;
            padding: 20px 40px;
            border-radius: 20px;
            font-size: 18px;
            font-weight: 800;
            border: none;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.2);
            display: flex;
            align-items: center;
            gap: 16px;
            transition: var(--transition);
        }

        .finalize-btn:hover {
            transform: scale(1.02) translateY(-2px);
            background: #059669;
        }

        .ready-badge {
            background: #dcfce7;
            color: #166534;
            padding: 6px 14px;
            border-radius: 100px;
            font-size: 11px;
            font-weight: 900;
            letter-spacing: 0.5px;
        }

        .summary-footer {
            margin-top: 40px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .support-info {
            max-width: 250px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 20px;
            font-size: 12px;
            color: #64748b;
            line-height: 1.6;
        }

        .support-info strong {
            color: #475569;
        }

        /* --- COMPLETION VIEW --- */
        .completion-view {
            text-align: center;
            max-width: 600px;
            margin: 60px auto;
            animation: slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .success-icon {
            width: 120px;
            height: 120px;
            background: #dcfce7;
            color: #166534;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            margin: 0 auto 40px;
            box-shadow: 0 20px 40px rgba(22, 101, 52, 0.1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- REPORT VIEW --- */
        .report-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-top: 32px;
        }

        .report-card {
            background: white;
            border-radius: 28px;
            padding: 32px;
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.05);
        }

        .risk-gauge {
            width: 100%;
            height: 12px;
            background: #f1f5f9;
            border-radius: 100px;
            margin: 20px 0;
            overflow: hidden;
            position: relative;
        }

        .risk-fill {
            height: 100%;
            background: linear-gradient(to right, #10b981, #f59e0b, #ef4444);
            transition: width 1.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .recommendation-list {
            list-style: none;
            padding: 0;
        }

        .recommendation-list li {
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            gap: 12px;
            font-size: 14px;
            color: var(--text-muted);
        }

        .recommendation-list li i {
            color: var(--brand-primary);
            margin-top: 3px;
        }

        .pill-large {
            padding: 8px 20px;
            border-radius: 100px;
            font-size: 12px;
            font-weight: 800;
            text-transform: uppercase;
        }
    </style>
</head>

<body>

    <aside class="sidebar">
        <div class="sidebar-brand">
            <div class="logo-box"><i class="fas fa-shield-heart"></i></div>
            <h1>Health<span>Bite</span></h1>
        </div>
        <nav class="nav-menu">
            <a href="#" class="nav-link active"><i class="fas fa-user-circle"></i> Profile Setup</a>
            <a href="user.html" class="nav-link profile-required" id="nav-dashboard"><i class="fas fa-home"></i>
                Dashboard</a>
            <a href="full-menu.html" class="nav-link profile-required" id="nav-canteen"><i class="fas fa-utensils"></i>
                Menu</a>
        </nav>

        <div class="sidebar-footer">
            <p style="font-size: 11px; color: #94a3b8; font-weight: 700;">SECURED ENCRYPTED DATA</p>
        </div>
    </aside>

    <main class="main-content">
        <div class="page-header">
            <span class="step-label" id="step-title">STEP 1 OF 3 ‚Äî PERSONAL BIOMETRICS</span>
            <h2 id="page-h2">Personal Info & Dietary Style</h2>

            <div class="progress-container">
                <div class="progress-fill" id="pb-fill"></div>
            </div>
            <div class="progress-info" id="pb-text">33% COMPLETE</div>
        </div>

        <!-- STEP 1 VIEW -->
        <div class="step-view active" id="step1">
            <div class="grid-layout">
                <!-- User Details Card -->
                <div class="setup-card">
                    <div class="card-title">
                        <div class="icon-box"><i class="fas fa-user"></i></div>
                        User Details
                    </div>

                    <div class="grid-layout" style="gap: 20px;">
                        <div class="input-group">
                            <label>Age</label>
                            <input type="number" class="input-field" id="age" placeholder="25">
                        </div>
                        <div class="input-group">
                            <label>Gender</label>
                            <select class="input-field" id="gender">
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid-layout" style="gap: 20px; margin-top: 20px;">
                        <div class="input-group">
                            <label>Weight (kg)</label>
                            <input type="number" class="input-field" id="weight" placeholder="70" oninput="calcBMI()">
                        </div>
                        <div class="input-group">
                            <label>Height (cm)</label>
                            <input type="number" class="input-field" id="height" placeholder="175" oninput="calcBMI()">
                        </div>
                    </div>

                    <!-- BMI ANALYSIS -->
                    <div class="bmi-gauge-box">
                        <div>
                            <span class="bmi-val" id="bmi-val">22.8</span>
                            <span class="bmi-unit">KG/M¬≤</span>
                            <div style="font-size: 10px; font-weight: 800; color: #94a3b8; margin-top: 4px;">BMI
                                ANALYSIS</div>
                        </div>
                        <span class="bmi-status-pill normal" id="bmi-status">NORMAL</span>
                    </div>
                </div>

                <!-- Dietary Style Card -->
                <div class="setup-card">
                    <div class="card-title">
                        <div class="icon-box"><i class="fas fa-leaf"></i></div>
                        Dietary Style
                    </div>

                    <div class="option-stack">
                        <div class="option-card" data-diet="Veg" onclick="setDiet('Veg')">
                            <div class="option-icon-box">ü•ó</div>
                            <div>
                                <h4>Vegetarian</h4>
                                <p>No meat, includes dairy/eggs</p>
                            </div>
                            <div class="check-mark"><i class="fas fa-check"></i></div>
                        </div>

                        <div class="option-card active" data-diet="Non-Veg" onclick="setDiet('Non-Veg')">
                            <div class="option-icon-box">üçñ</div>
                            <div>
                                <h4>Omnivore (Non-Veg)</h4>
                                <p>No specific dietary restrictions</p>
                            </div>
                            <div class="check-mark"><i class="fas fa-check"></i></div>
                        </div>

                        <div class="option-card" data-diet="Vegan" onclick="setDiet('Vegan')">
                            <div class="option-icon-box">üå±</div>
                            <div>
                                <h4>Vegan</h4>
                                <p>Strict plant-based lifestyle</p>
                            </div>
                            <div class="check-mark"><i class="fas fa-check"></i></div>
                        </div>
                    </div>
                </div>

                <!-- AI PRE-SCAN -->
                <div class="prescan-banner">
                    <div class="prescan-item">
                        <div class="prescan-dot dot-green"></div>
                        <div>
                            <h5>Metabolic Balance</h5>
                            <p>Optimized for your BMI range.</p>
                        </div>
                    </div>
                    <div class="prescan-item">
                        <div class="prescan-dot dot-yellow"></div>
                        <div>
                            <h5>Caloric Target</h5>
                            <p>Dynamic adjustments based on profile.</p>
                        </div>
                    </div>
                    <div class="prescan-item">
                        <div class="prescan-dot dot-red"></div>
                        <div>
                            <h5>Safety Protocol</h5>
                            <p>Awaiting medical markers in next step.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="action-bar">
                <button class="btn btn-primary" onclick="nextStep()">
                    Next: Health Conditions <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- STEP 2 VIEW -->
        <div class="step-view" id="step2">
            <div class="grid-layout">
                <!-- ... existing step 2 content ... -->
                <!-- Health Conditions -->
                <div class="setup-card">
                    <div class="card-title">
                        <div class="icon-box"><i class="fas fa-heartbeat"></i></div>
                        Health Conditions
                    </div>

                    <div class="condition-grid">
                        <!-- None -->
                        <div class="cond-card" id="cond-none-card">
                            <div class="cond-header" onclick="toggleCondition('none')">
                                <div class="option-icon-box">üö´</div>
                                <div>
                                    <h4>None</h4>
                                    <p>No chronic conditions to report</p>
                                </div>
                                <div class="check-mark" id="check-none"><i class="fas fa-check"></i></div>
                            </div>
                        </div>

                        <!-- Diabetes -->
                        <div class="cond-card" id="cond-diabetes-card">
                            <div class="cond-header" onclick="toggleCondition('diabetes')">
                                <div class="option-icon-box">üíä</div>
                                <div>
                                    <h4>Diabetes</h4>
                                    <p>Monitoring Sugar Intake</p>
                                </div>
                                <div class="check-mark" id="check-diabetes"><i class="fas fa-check"></i></div>
                            </div>
                            <div class="cond-expanded">
                                <div class="exp-row">
                                    <div class="input-group">
                                        <label>Severity</label>
                                        <select class="input-field" id="sev-diabetes">
                                            <option value="Mild">Mild</option>
                                            <option value="Moderate" selected>Moderate</option>
                                            <option value="Severe">Severe</option>
                                        </select>
                                    </div>
                                    <div class="input-group">
                                        <label>Sugar Value (mg/dL)</label>
                                        <input type="number" class="input-field" id="val-diabetes" placeholder="145">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Hypertension -->
                        <div class="cond-card" id="cond-hypertension-card">
                            <div class="cond-header" onclick="toggleCondition('hypertension')">
                                <div class="option-icon-box">ü©∫</div>
                                <div>
                                    <h4>Hypertension</h4>
                                    <p>High Blood Pressure</p>
                                </div>
                                <div class="check-mark" id="check-hypertension"><i class="fas fa-check"></i></div>
                            </div>
                            <div class="cond-expanded">
                                <div class="exp-row">
                                    <div class="input-group">
                                        <label>Severity</label>
                                        <select class="input-field" id="sev-hypertension">
                                            <option value="Mild">Mild</option>
                                            <option value="Moderate">Moderate</option>
                                            <option value="Severe">Severe</option>
                                        </select>
                                    </div>
                                    <div class="input-group">
                                        <label>BP (Systolic)</label>
                                        <input type="number" class="input-field" id="val-hypertension"
                                            placeholder="130">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Allergies -->
                <div class="setup-card">
                    <div class="card-title">
                        <div class="icon-box"><i class="fas fa-bacteria"></i></div>
                        Allergies & Sensitivities
                    </div>

                    <div class="allergy-grid">
                        <div class="allergy-item" id="alg-nuts" onclick="toggleAllergy('nuts')">
                            <span>ü•ú</span> Nuts
                        </div>
                        <div class="allergy-item" id="alg-milk" onclick="toggleAllergy('milk')">
                            <span>ü•õ</span> Milk
                        </div>
                        <div class="allergy-item" id="alg-seafood" onclick="toggleAllergy('seafood')">
                            <span>ü¶ê</span> Seafood
                        </div>
                        <div class="allergy-item" id="alg-gluten" onclick="toggleAllergy('gluten')">
                            <span>üåæ</span> Gluten
                        </div>
                        <div class="allergy-item" id="alg-soy" onclick="toggleAllergy('soy')">
                            <span>ü´ò</span> Soy
                        </div>
                        <div class="allergy-item" id="alg-none" onclick="toggleAllergy('none')">
                            <span>üö´</span> None
                        </div>
                    </div>

                    <div
                        style="margin-top: 32px; padding: 20px; background: #fff1f2; border: 1px dashed #f87171; border-radius: 20px; color: #991b1b; font-size: 13px; display: flex; gap: 12px;">
                        <i class="fas fa-info-circle" style="margin-top: 2px;"></i>
                        <p><strong>Safety Note:</strong> Severe allergies will completely block unsafe food items from
                            your meal recommendations across the entire platform.</p>
                    </div>
                </div>
            </div>

            <div class="action-bar">
                <button class="btn btn-outline" onclick="prevStep()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <button class="btn btn-primary" onclick="nextStep()">
                    Review Summary <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- STEP 3 VIEW (SUMMARY) -->
        <div class="step-view" id="step3">
            <div class="summary-header">
                <div>
                    <h2 style="font-size: 28px; font-weight: 800; margin-bottom: 4px;">Review Summary</h2>
                    <p style="color: var(--text-muted); font-weight: 600;">Final review of your health data</p>
                </div>
                <div class="ready-badge">READY TO FINALIZE</div>
            </div>

            <!-- Demographics -->
            <div class="summary-card">
                <div class="summary-header" style="margin-bottom: 24px;">
                    <div class="summary-section-title">
                        <i class="fas fa-id-card" style="color: var(--brand-primary);"></i>
                        User Demographics
                    </div>
                    <button class="edit-btn" onclick="goToStep(1)"><i class="fas fa-pen"></i> Edit</button>
                </div>
                <div class="summary-grid">
                    <div class="summary-item">
                        <label>Age</label>
                        <span id="sum-age">28</span>
                    </div>
                    <div class="summary-item">
                        <label>Gender</label>
                        <span id="sum-gender">Female</span>
                    </div>
                    <div class="summary-item">
                        <label>Weight</label>
                        <span id="sum-weight">74</span><span class="unit">kg</span>
                    </div>
                    <div class="summary-item">
                        <label>Height</label>
                        <span id="sum-height">170</span><span class="unit">cm</span>
                    </div>
                </div>

                <div class="bmi-mini-gauge">
                    <div style="min-width: 140px;">
                        <label
                            style="display: block; font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase;">Calculated
                            BMI</label>
                        <div style="display: flex; align-items: baseline; gap: 8px; margin-top: 4px;">
                            <span id="sum-bmi" style="font-size: 24px; font-weight: 800;">25.6</span>
                            <span class="bmi-status-pill normal" id="sum-bmi-status">NORMAL RANGE</span>
                        </div>
                    </div>
                    <div class="bmi-bar-bg">
                        <div class="bmi-marker" id="sum-bmi-marker" style="left: 50%;"></div>
                    </div>
                </div>
            </div>

            <div class="grid-layout">
                <!-- Dietary -->
                <div class="summary-card">
                    <div class="summary-header" style="margin-bottom: 24px;">
                        <div class="summary-section-title">
                            <i class="fas fa-utensils" style="color: var(--brand-primary);"></i>
                            Dietary Style
                        </div>
                        <button class="edit-btn" onclick="goToStep(1)"><i class="fas fa-pen"></i> Edit</button>
                    </div>
                    <div class="dietary-summary-card">
                        <div class="option-icon-box" id="sum-diet-icon">ü•ó</div>
                        <div>
                            <h4 id="sum-diet-name">Vegetarian</h4>
                            <p id="sum-diet-desc">No meat, includes dairy/eggs</p>
                        </div>
                    </div>
                </div>

                <div class="grid-layout" style="gap: 20px;">
                    <!-- Clinical -->
                    <div class="summary-card">
                        <div class="summary-header" style="margin-bottom: 20px;">
                            <div class="summary-section-title">
                                <i class="fas fa-notes-medical" style="color: var(--brand-primary);"></i>
                                Clinical Status
                            </div>
                            <button class="edit-btn" onclick="goToStep(2)"><i class="fas fa-pen"></i> Edit</button>
                        </div>
                        <div class="clinical-stack" id="sum-clinical-stack">
                            <!-- Populated by JS -->
                        </div>
                        <p style="margin-top: 20px; font-size: 13px; font-weight: 700; color: var(--text-muted); cursor: pointer;"
                            onclick="goToStep(2)">Update All Sections</p>
                    </div>

                    <!-- Safety -->
                    <div class="summary-card">
                        <div class="summary-header" style="margin-bottom: 20px;">
                            <div class="summary-section-title">
                                <i class="fas fa-exclamation-triangle" style="color: #10b981;"></i>
                                Safety Constraints
                            </div>
                            <button class="edit-btn" onclick="goToStep(2)"><i class="fas fa-pen"></i> Edit</button>
                        </div>
                        <div class="safety-list" id="sum-safety-list">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="summary-footer">
                <div class="support-info">
                    <strong>SUPPORT</strong><br>
                    Consult a doctor before major changes.
                </div>
                <button class="finalize-btn" id="save-btn" onclick="finalSave()">
                    Finalize & Generate Report <i class="fas fa-magic"></i>
                </button>
            </div>
        </div>

        <!-- COMPLETION VIEW -->
        <div class="step-view" id="step-completed">
            <div class="completion-view">
                <div class="success-icon">
                    <i class="fas fa-check-double"></i>
                </div>
                <h2 style="font-size: 36px; font-weight: 800; margin-bottom: 16px;">Health Profile Completed!</h2>
                <p style="font-size: 18px; color: var(--text-muted); margin-bottom: 40px; line-height: 1.6;">
                    Your personalized health profile has been created.<br>
                    You can now view your detailed health analysis and recommendations.
                </p>
                <button class="btn btn-primary" style="padding: 20px 60px; margin: 0 auto;" onclick="loadReport()">
                    View My Health Report <i class="fas fa-file-medical"></i>
                </button>
            </div>
        </div>

        <!-- REPORT VIEW -->
        <div class="step-view" id="step-report">
            <div class="summary-header">
                <div>
                    <h2 style="font-size: 32px; font-weight: 800;">Your Health Analysis Report</h2>
                    <p style="color: var(--text-muted); font-weight: 600;">Personalized insights based on your profile
                    </p>
                </div>
                <button class="btn btn-outline" onclick="editProfile()">
                    <i class="fas fa-pen"></i> Update Profile
                </button>
            </div>

            <div class="report-grid">
                <!-- Personal Summary -->
                <div class="report-card">
                    <div class="card-title">
                        <div class="icon-box"><i class="fas fa-user-circle"></i></div>
                        Personal Data
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="summary-item"><label>Age</label><span id="rep-age">-</span></div>
                        <div class="summary-item"><label>Gender</label><span id="rep-gender">-</span></div>
                        <div class="summary-item"><label>BMI</label><span id="rep-bmi">-</span></div>
                        <div class="summary-item"><label>Category</label><span id="rep-bmi-cat"
                                class="status-pill mild">-</span></div>
                    </div>
                </div>

                <!-- Risk Analysis -->
                <div class="report-card">
                    <div class="card-title">
                        <div class="icon-box"><i class="fas fa-shield-virus"></i></div>
                        Health Risk Evaluation
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 40px; font-weight: 800;" id="rep-risk-score">0</div>
                        <div style="font-size: 12px; font-weight: 800; color: var(--text-muted); margin-top: 4px;">
                            OVERALL RISK SCORE</div>
                        <div class="risk-gauge">
                            <div class="risk-fill" id="rep-risk-fill" style="width: 0%"></div>
                        </div>
                        <span id="rep-risk-level" class="pill-large" style="background: #dcfce7; color: #166534;">LOW
                            RISK</span>
                    </div>
                </div>

                <!-- Recommendations -->
                <div class="report-card">
                    <div class="card-title">
                        <div class="icon-box"><i class="fas fa-lightbulb"></i></div>
                        Key Recommendations
                    </div>
                    <ul class="recommendation-list" id="rep-recs">
                        <!-- Populated by JS -->
                    </ul>
                </div>

                <!-- Conditions -->
                <div class="report-card" style="grid-column: span 2;">
                    <div class="card-title">
                        <div class="icon-box"><i class="fas fa-notes-medical"></i></div>
                        Clinical Markers & Conditions
                    </div>
                    <div style="display: flex; gap: 16px; flex-wrap: wrap;" id="rep-conditions">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Allergy Risks -->
                <div class="report-card">
                    <div class="card-title">
                        <div class="icon-box"><i class="fas fa-exclamation-triangle"></i></div>
                        Active Allergy Risks
                    </div>
                    <div class="safety-list" id="rep-allergies">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <div style="margin-top: 40px; display: flex; justify-content: center;">
                <button class="finalize-btn" style="background: var(--brand-primary);"
                    onclick="window.location.href='user.html'">
                    Continue to Dashboard <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </main>

    <!-- Toast -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toast-msg">Success!</span>
    </div>

    <script src="script.js"></script>
    <script>
        let currentStep = 1;
        let currentDiet = 'Non-Veg';
        const activeConditions = new Set();
        const activeAllergies = new Set();

        window.addEventListener('DOMContentLoaded', async () => {
            const hasProfile = await checkProfileCompletion();
            if (!hasProfile) {
                // Hide dashboard and menu links if profile not completed
                document.querySelectorAll('.profile-required').forEach(el => {
                    el.style.display = 'none';
                });
            }
        });

        const dietData = {
            'Veg': { name: 'Vegetarian', icon: 'ü•ó', desc: 'No meat, includes dairy/eggs' },
            'Non-Veg': { name: 'Omnivore (Non-Veg)', icon: 'üçñ', desc: 'No specific dietary restrictions' },
            'Vegan': { name: 'Vegan', icon: 'üå±', desc: 'Strict plant-based lifestyle' }
        };

        function setDiet(type) {
            currentDiet = type;
            document.querySelectorAll('.option-card').forEach(c => c.classList.remove('active'));
            document.querySelector(`[data-diet="${type}"]`).classList.add('active');
        }

        function calcBMI() {
            const w = parseFloat(document.getElementById('weight').value);
            const h = parseFloat(document.getElementById('height').value);
            if (!w || !h) return;
            const bmi = (w / ((h / 100) * (h / 100))).toFixed(1);

            // Update UI in Step 1
            const bmiVal = document.getElementById('bmi-val');
            if (bmiVal) bmiVal.innerText = bmi;

            const pill = document.getElementById('bmi-status');
            if (pill) {
                pill.className = 'bmi-status-pill';
                if (bmi < 18.5) { pill.innerText = 'UNDERWEIGHT'; pill.classList.add('underweight'); }
                else if (bmi < 25) { pill.innerText = 'NORMAL'; pill.classList.add('normal'); }
                else if (bmi < 30) { pill.innerText = 'OVERWEIGHT'; pill.classList.add('overweight'); }
                else { pill.innerText = 'OBESE'; pill.classList.add('obese'); }
            }
        }

        function toggleCondition(id) {
            const card = document.getElementById(`cond-${id}-card`);
            if (id === 'none') {
                activeConditions.clear();
                document.querySelectorAll('.cond-card').forEach(c => c.classList.remove('active'));
                card.classList.add('active');
                activeConditions.add('none');
            } else {
                document.getElementById('cond-none-card').classList.remove('active');
                activeConditions.delete('none');

                if (activeConditions.has(id)) {
                    activeConditions.delete(id);
                    card.classList.remove('active');
                } else {
                    activeConditions.add(id);
                    card.classList.add('active');
                }
            }
        }

        function toggleAllergy(id) {
            const item = document.getElementById(`alg-${id}`);
            if (id === 'none') {
                activeAllergies.clear();
                document.querySelectorAll('.allergy-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                activeAllergies.add('none');
            } else {
                const noneItem = document.getElementById('alg-none');
                if (noneItem) noneItem.classList.remove('active');
                activeAllergies.delete('none');

                if (activeAllergies.has(id)) {
                    activeAllergies.delete(id);
                    item.classList.remove('active');
                } else {
                    activeAllergies.add(id);
                    item.classList.add('active');
                }
            }
        }

        async function nextStep() {
            const token = localStorage.getItem('token');
            if (!token) return;

            if (currentStep === 1) {
                const age = document.getElementById('age').value;
                const weight = document.getElementById('weight').value;
                const height = document.getElementById('height').value;

                if (!age || !weight || !height) {
                    showToast('Please fill in your biometrics', 'error');
                    return;
                }

                const data = {
                    age: parseInt(age),
                    gender: document.getElementById('gender').value,
                    weight_kg: parseFloat(weight),
                    height_cm: parseFloat(height),
                    dietary_preference: currentDiet
                };

                try {
                    const res = await fetch(`${API_ROOT}/health/step1`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    if (!res.ok) {
                        const err = await res.json().catch(() => ({ detail: 'Save failed' }));
                        throw new Error(err.detail);
                    }

                    showStep(2);
                } catch (e) {
                    showToast(e.message || 'Failed to save progress', 'error');
                }
            } else if (currentStep === 2) {
                const data = {
                    disease: Array.from(activeConditions).filter(c => c !== 'none').map(c => c.charAt(0).toUpperCase() + c.slice(1)),
                    severity: {},
                    health_values: {},
                    allergies: Array.from(activeAllergies).filter(a => a !== 'none').map(a => ({
                        name: a.charAt(0).toUpperCase() + a.slice(1),
                        severity: 'Moderate' // Could be expanded to dynamic selection later
                    }))
                };

                activeConditions.forEach(c => {
                    if (c !== 'none') {
                        const sevEl = document.getElementById(`sev-${c}`);
                        const valEl = document.getElementById(`val-${c}`);
                        data.severity[c] = sevEl ? sevEl.value : 'Mild';
                        data.health_values[c] = valEl ? parseFloat(valEl.value) || 0 : 0;
                    }
                });

                try {
                    const res = await fetch(`${API_ROOT}/health/step2`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    if (!res.ok) {
                        const err = await res.json().catch(() => ({ detail: 'Save failed' }));
                        throw new Error(err.detail);
                    }

                    populateSummary();
                    showStep(3);
                } catch (e) {
                    showToast(e.message || 'Failed to save medical data', 'error');
                }
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                showStep(currentStep - 1);
            }
        }


        function populateSummary() {
            // Demographics
            document.getElementById('sum-age').innerText = document.getElementById('age').value;
            document.getElementById('sum-gender').innerText = document.getElementById('gender').value;
            document.getElementById('sum-weight').innerText = document.getElementById('weight').value;
            document.getElementById('sum-height').innerText = document.getElementById('height').value;

            const bmi = document.getElementById('bmi-val').innerText;
            document.getElementById('sum-bmi').innerText = bmi;

            const sumPill = document.getElementById('sum-bmi-status');
            const bmiFloat = parseFloat(bmi);
            sumPill.className = 'bmi-status-pill';
            if (bmiFloat < 18.5) { sumPill.innerText = 'UNDERWEIGHT'; sumPill.classList.add('underweight'); }
            else if (bmiFloat < 25) { sumPill.innerText = 'NORMAL'; sumPill.classList.add('normal'); }
            else if (bmiFloat < 30) { sumPill.innerText = 'OVERWEIGHT'; sumPill.classList.add('overweight'); }
            else { sumPill.innerText = 'OBESE'; sumPill.classList.add('obese'); }

            // Marker position (simple linear mapping for visual)
            let markerPos = ((bmiFloat - 15) / 20) * 100;
            markerPos = Math.max(5, Math.min(95, markerPos));
            document.getElementById('sum-bmi-marker').style.left = markerPos + '%';

            // Diet
            const diet = dietData[currentDiet];
            document.getElementById('sum-diet-icon').innerText = diet.icon;
            document.getElementById('sum-diet-name').innerText = diet.name;
            document.getElementById('sum-diet-desc').innerText = diet.desc;

            // Clinical
            const clinicalStack = document.getElementById('sum-clinical-stack');
            clinicalStack.innerHTML = '';
            const conditions = Array.from(activeConditions).filter(c => c !== 'none');

            if (conditions.length === 0) {
                clinicalStack.innerHTML = '<p style="font-size: 14px; color: var(--text-muted);">No conditions reported</p>';
            } else {
                conditions.forEach(c => {
                    const sev = document.getElementById(`sev-${c}`) ? document.getElementById(`sev-${c}`).value : 'Mild';
                    const val = document.getElementById(`val-${c}`) ? document.getElementById(`val-${c}`).value : 0;
                    const unit = c === 'Diabetes' || c === 'diabetes' ? 'mg/dL' : 'mmHg';

                    clinicalStack.innerHTML += `
                        <div class="clinical-item">
                            <div class="clinical-info">
                                <h5>${c.charAt(0).toUpperCase() + c.slice(1)}</h5>
                                <p>${val} <span style="font-size: 10px; color: #94a3b8;">${unit} (AVG)</span></p>
                            </div>
                            <span class="status-pill ${sev.toLowerCase()}">${sev}</span>
                        </div>
                    `;
                });
            }

            // Safety
            const safetyList = document.getElementById('sum-safety-list');
            safetyList.innerHTML = '';
            const allergies = Array.from(activeAllergies).filter(a => a !== 'none');

            const allergyIcons = { 'nuts': 'ü•ú', 'milk': 'ü•õ', 'seafood': 'ü¶ê', 'gluten': 'üåæ', 'soy': 'ü´ò' };
            const allergySeverities = { 'nuts': 'FATAL', 'seafood': 'SEVERE', 'milk': 'MILD', 'gluten': 'MODERATE', 'soy': 'MILD' };

            if (allergies.length === 0) {
                safetyList.innerHTML = '<p style="font-size: 14px; color: var(--text-muted);">No allergies reported</p>';
            } else {
                allergies.forEach(a => {
                    const sev = allergySeverities[a] || 'MILD';
                    safetyList.innerHTML += `
                        <div class="safety-item">
                            <div style="display: flex; align-items: center; gap: 10px; font-weight: 700;">
                                <span>${allergyIcons[a] || 'üö´'}</span> ${a.charAt(0).toUpperCase() + a.slice(1)}
                            </div>
                            <span class="severity-label severity-${sev.toLowerCase()}">${sev}</span>
                        </div>
                    `;
                });
            }
        }

        function showToast(msg, type = 'success') {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.className = `toast toast-${type} active`;
            setTimeout(() => t.classList.remove('active'), 3000);
        }

        async function finalSave() {
            const token = localStorage.getItem('token');
            const btn = document.getElementById('save-btn');

            btn.innerHTML = 'Generating Results... <i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                const res = await fetch(`${API_ROOT}/health/finalize`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    showToast('Profile Successfully Completed!');
                    showStep('completed');
                } else {
                    const errData = await res.json().catch(() => ({}));
                    showToast(errData.detail || 'Finalization failed', 'error');
                }
            } catch (e) {
                showToast('Network error.', 'error');
            } finally {
                btn.innerHTML = 'Finalize & Generate Report <i class="fas fa-magic"></i>';
                btn.disabled = false;
            }
        }

        async function loadReport() {
            const token = localStorage.getItem('token');
            try {
                const res = await fetch(`${API_ROOT}/health/report`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                // Show report step
                showStep('report');

                // Update active sidebar link
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                const repMenu = document.getElementById('menu-report');
                if (repMenu) repMenu.classList.add('active');

                // Populate report
                document.getElementById('rep-age').innerText = data.age;
                document.getElementById('rep-gender').innerText = data.gender;
                document.getElementById('rep-bmi').innerText = data.bmi.toFixed(1);
                document.getElementById('rep-bmi-cat').innerText = data.bmi_category;

                document.getElementById('rep-risk-score').innerText = data.risk_score;
                const riskFill = document.getElementById('rep-risk-fill');
                riskFill.style.width = data.risk_score + '%';

                const riskLevel = document.getElementById('rep-risk-level');
                riskLevel.innerText = `${data.risk_level} RISK`;
                riskLevel.style.background = data.risk_level === 'High' ? '#fee2e2' : (data.risk_level === 'Moderate' ? '#fef3c7' : '#dcfce7');
                riskLevel.style.color = data.risk_level === 'High' ? '#991b1b' : (data.risk_level === 'Moderate' ? '#92400e' : '#166534');

                // Recommendations
                const recsList = document.getElementById('rep-recs');
                recsList.innerHTML = data.recommendations.map(r => `<li><i class="fas fa-check"></i> ${r}</li>`).join('');

                // Conditions
                const condsList = document.getElementById('rep-conditions');
                condsList.innerHTML = (data.disease && data.disease.length > 0) ? data.disease.map(c => `
                    <div class="status-pill moderate" style="padding: 10px 20px;">${c}</div>
                `).join('') : '<p style="color: grey">No chronic conditions</p>';

                // Allergies
                const algList = document.getElementById('rep-allergies');
                algList.innerHTML = (data.allergies && data.allergies.length > 0) ? data.allergies.map(a => `
                    <div class="safety-item">
                        <span>${a.name}</span>
                        <span class="severity-label severity-fatal">${a.severity}</span>
                    </div>
                `).join('') : '<p style="color: grey">No active allergies</p>';

            } catch (e) {
                showToast('Failed to load report', 'error');
            }
        }

        async function editProfile() {
            // Update active sidebar link
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            const updMenu = document.getElementById('menu-update');
            if (updMenu) updMenu.classList.add('active');

            // Fetch and populate before going to step 1
            await fetchAndPopulateProfile();

            // Reset to step 1
            showStep(1);
        }

        async function fetchAndPopulateProfile() {
            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                const res = await fetch(`${API_ROOT}/health/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) return;

                const data = await res.json();

                // Step 1 data
                document.getElementById('age').value = data.age || '';
                document.getElementById('gender').value = data.gender || 'Male';
                document.getElementById('weight').value = data.weight_kg || '';
                document.getElementById('height').value = data.height_cm || '';

                if (data.dietary_preference) {
                    setDiet(data.dietary_preference);
                }

                // Step 2 data - Conditions
                activeConditions.clear();
                document.querySelectorAll('.cond-card').forEach(c => c.classList.remove('active'));

                if (data.disease && data.disease.length > 0) {
                    data.disease.forEach(diseaseName => {
                        const id = diseaseName.toLowerCase();
                        activeConditions.add(id);
                        const card = document.getElementById(`cond-${id}-card`);
                        if (card) card.classList.add('active');

                        // Set severity and values if they exist
                        if (data.severity && data.severity[id]) {
                            const sevEl = document.getElementById(`sev-${id}`);
                            if (sevEl) sevEl.value = data.severity[id];
                        }
                        if (data.health_values && data.health_values[id]) {
                            const valEl = document.getElementById(`val-${id}`);
                            if (valEl) valEl.value = data.health_values[id];
                        }
                    });
                } else {
                    activeConditions.add('none');
                    document.getElementById('cond-none-card').classList.add('active');
                }

                // Step 2 data - Allergies
                activeAllergies.clear();
                document.querySelectorAll('.allergy-item').forEach(i => i.classList.remove('active'));

                if (data.allergies && data.allergies.length > 0) {
                    data.allergies.forEach(allergy => {
                        const id = allergy.name ? allergy.name.toLowerCase() : allergy.toLowerCase();
                        activeAllergies.add(id);
                        const item = document.getElementById(`alg-${id}`);
                        if (item) item.classList.add('active');
                    });
                } else {
                    activeAllergies.add('none');
                    document.getElementById('alg-none').classList.add('active');
                }

                calcBMI();
            } catch (e) {
                console.error("Failed to fetch profile for editing:", e);
                showToast('Failed to load existing profile data', 'error');
            }
        }

        // Initialize values
        document.addEventListener('DOMContentLoaded', async () => {
            calcBMI();

            const token = localStorage.getItem('token');
            const urlParams = new URLSearchParams(window.location.search);
            const viewParam = urlParams.get('view');

            if (token) {
                try {
                    const res = await fetch(`${API_ROOT}/health/check`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!res.ok) throw new Error("Check failed");

                    const info = await res.json();

                    if (info.has_profile) {
                        // User has completed profile
                        updateSidebarForCompletedProfile();

                        if (viewParam === 'update') {
                            await fetchAndPopulateProfile();
                            showStep(1);
                        } else {
                            loadReport();
                        }
                    } else {
                        // Resumable onboarding
                        // If they have some progress, load it first
                        if (info.onboarding_step > 0) {
                            await fetchAndPopulateProfile();
                            // If they did step 2 but didn't finalized, go to summary (3)
                            // If they did step 1 but didn't do step 2, go to 2
                            const nextToRun = info.onboarding_step + 1;
                            showStep(Math.min(3, nextToRun));
                        } else {
                            showStep(1);
                        }
                    }
                } catch (e) {
                    console.error("Health initialization failed:", e);
                    showStep(1);
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        function updateSidebarForCompletedProfile() {
            const navMenu = document.querySelector('.nav-menu');
            if (navMenu) {
                navMenu.innerHTML = `
                    <a href="#" class="nav-link active" id="menu-report" onclick="loadReport()"><i class="fas fa-file-medical"></i> Health Report</a>
                    <a href="#" class="nav-link" id="menu-update" onclick="editProfile()"><i class="fas fa-pen-to-square"></i> Update Profile</a>
                    <div style="margin: 20px 0; border-top: 1px solid #f1f5f9;"></div>
                    <a href="user.html" class="nav-link"><i class="fas fa-home"></i> Back to Dashboard</a>
                `;
            }
        }

        /**
         * Enterprise Refactored Navigation
         * Handles numeric steps (1, 2, 3) and named views (completed, report)
         */
        function showStep(target) {
            // Hide all views first
            document.querySelectorAll('.step-view').forEach(v => v.classList.remove('active'));

            if (typeof target === 'number') {
                const stepEl = document.getElementById(`step${target}`);
                if (stepEl) {
                    stepEl.classList.add('active');
                    currentStep = target;

                    // Show/Update Header UI
                    const header = document.querySelector('.page-header');
                    if (header) header.style.display = 'block';

                    const titles = {
                        1: { label: 'STEP 1 OF 3 ‚Äî PERSONAL BIOMETRICS', head: 'Personal Info & Dietary Style', progress: '33%' },
                        2: { label: 'STEP 2 OF 3 ‚Äî HEALTH & ALLERGIES', head: 'Medical Conditions', progress: '66%' },
                        3: { label: 'STEP 3 OF 3 ‚Äî REVIEW PROFILE', head: 'Review & Finalize', progress: '100%' }
                    };

                    const updateUI = titles[target];
                    if (updateUI) {
                        document.getElementById('step-title').innerText = updateUI.label;
                        document.getElementById('page-h2').innerText = updateUI.head;
                        document.getElementById('pb-fill').style.width = updateUI.progress;
                        document.getElementById('pb-text').innerText = `${updateUI.progress} COMPLETE`;
                    }
                }
            } else {
                // Handle named screens like 'completed' or 'report'
                const viewEl = document.getElementById(`step-${target}`);
                if (viewEl) {
                    viewEl.classList.add('active');
                    // Hide wizard header for final reports
                    const header = document.querySelector('.page-header');
                    if (header) header.style.display = 'none';
                }
            }

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>

</html>